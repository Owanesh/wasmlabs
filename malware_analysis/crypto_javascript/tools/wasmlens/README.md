# WasmLens 🔍

wasmlens is a small Bun-based tracing harness that drives Chromium (via Puppeteer) to record deep runtime traces focused on WebAssembly, blob/resources, workers and network activity. It's intended for malware/wasm analysis, research, and creating detailed DevTools traces for offline analysis.

## Quick start

**Requirements**
- Bun runtime (https://bun.sh)
- A Chromium/Chrome binary available on macOS (the script uses `/Applications/Chromium.app/Contents/MacOS/Chromium` by default but you can override it with `--chrome`)

Install dependencies

```bash
bun install
```

Basic run

```bash
# run a trace of a local file or http(s) URL
bun run index.ts --url ../index.html --deep 
```
Example run

```bash
bun trace_deep
```


## Main flags

- `--url` (string, required) — URL or local path (relative/absolute) to open and trace. Local files are converted to `file://` if the path exists.
- `--ssl-ignore-errors` (boolean, default: false) — pass through to Puppeteer `ignoreHTTPSErrors` to skip TLS validation.
- `--deep` (boolean, default: false) — enable a larger set of tracing categories for more detailed runtime data.
- `--timeout` (number, default: 9) — seconds to wait after the page `load` event before ending the trace (increase to capture late-loading workers/blobs).
- `--categories` (string) — comma-separated extra tracing categories to append.
- `--out` (string, default: `traces_output`) — base output folder; a timestamped subfolder is created for each run.
- `--chrome` (string) — path to a Chromium/Chrome binary to use instead of the built-in default.

Example with options

```bash
bun run index.ts -url https://example.com --ssl-ignore-errors --deep --timeout 12 --out my_traces --chrome "/Applications/Chromium.app/Contents/MacOS/Chromium"
```

## What the script records and where files are written

For each run the script creates an output folder at `<out>/<ISO-timestamp>/` with the following layout:

- `trace.json` — the raw Chrome trace stream (JSON). Written while collecting.
- `trace.json.gz` — gzip of the raw trace; created after `trace.json` is fully written (this ensures correct gzip size).
- `report.md` — a short run report (metadata, sizes, categories, timeout used).
- `files/` — saved resource files captured during the run. The script saves any `.wasm` responses and page-created blob resources here.
- `turbo/` — any `turbo-*.json` or `turbo-*.cfg` artifacts that Chromium emits in the working directory are moved here at the end of the run.

Example output tree

```
traces_output/
└─ <timestamp>/
	├─ trace.json
	├─ trace.json.gz
	├─ report.md
	├─ files/
	│  └─ some-module.wasm
	└─ turbo/
		└─ turbo-12345.json
```

Notes on gzip: the script writes the raw trace stream to `trace.json` while tracing. After the stream is closed it creates `trace.json.gz` from the saved file — this avoids the zero-byte gzip issue caused by streaming directly into a compressor.

## How resources are captured

- **Network responses**: the script listens to `page.on('response')` and saves `.wasm` responses or responses with `application/wasm`/`application/octet-stream` that look like wasm to the `files/` folder.
- **In-page blobs**: the script injects a small `URL.createObjectURL` wrapper via `evaluateOnNewDocument` and exposes `window.__wasmlens_save_blob` to pass base64-encoded blobs back to Bun; those are written into `files/` as well.

This combination captures server-side `.wasm` binaries and client-generated blobs created at runtime.

## Logging and troubleshooting

- The script prints the output directory at startup and logs high-level progress (browser launch, tracing start/end, files saved, gzip sizes).
- If you see `gzipBytes: 0` in the report, the most common reason is a failure to write `trace.json` — check `trace.json` exists and is non-empty.
- If no `turbo-*.json` files appear, Chromium may not have produced them; the script scans the working directory at the end of the run and moves any that match the `turbo-*.json` or `turbo-*.cfg` pattern into the per-run `turbo/` folder.
